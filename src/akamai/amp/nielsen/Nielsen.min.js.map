{"version":3,"sources":["../../../../src/Nielsen.js","../../../../src/main.js"],"names":["bindHandlers","config","data","dtvr","sdk","NOLCMB","isDTVR","fireBeacon","currentTime","toFixed","events","type","video","vo","codes","player","logger","log","eventName","object","target","ads","this","onadstarted","onadended","addEventListener","adVO","position","totalAds","generateNielsenVO","floor","event","body","info","akamai","amp","Plugin","registerPlugin"],"mappings":"kTAKSA,QAA6B,IAA7BA,EAAcC,OAAAC,KAADC,YACbC,iBAAaC,eAAlB,iBACKC,GAAUC,WAAKN,MAAYE,EAAjBK,YAAfC,QAAA,sJAMMC,iBAEN,MAAQC,EAARC,QAAAC,EAAAH,EAAAE,gJAmBME,oBAAQ,2BAAdC,OAAAC,OAAAC,IAAA,qCAAAC,EAAAC,6FAcMC,iBAAqBC,cAA3BC,KAAAC,eACIH,iBAAgB,YAAAE,KAAAE,aACXC,iBAAiB,iBAAeH,KAAKC,+FAQjC,YAAPZ,GAAN,GAAAW,KAAAI,KAAAC,UAAAL,KAAAf,WAAA,OAAAe,KAAAd,aAEY,WAARG,GAAAW,KAAqBf,WAAUoB,eAC5BpB,KAAAA,kBAAmB,YAEd,MAARI,KAAAA,wKAQMW,KAAAI,KAAAE,UAAAF,KAAAC,UAAAL,KAAAf,WAAA,eAAAe,KAAAO,kBAAA,gFAOJrB,MAAAA,aAAmBsB,4BAErBvB,WAAKC,aAAeA,KAAaA,8GAM3Bc,KAAAO,kBAAAP,KAAAI,KAAAf,YAEHJ,WAAW,eAAasB,KAAAA,kBAAuBH,uNAaxClB,4BAEVD,WAAKC,aAAeA,KAAaA,2LAUvBuB,KAAOC,KAAAC,uCAjHYC,IAAOC,IAAIC,eAAAA,UAAAA,EAAAA,SCEhDF,EAAOC,QAAQE","file":"akamai/amp/nielsen/Nielsen.min.js","sourcesContent":["export default class Nielsen extends akamai.amp.Plugin {\n\n  constructor(player, config) {\n    super(player, config)\n\n    this.bindHandlers([\"onadstarted\", \"onadended\", \"onadtimeupdate\"])\n    this.sdk = window.NOLCMB.getInstance()\n    this.isDTVR = (this.config.data.dtvr === true)\n    window.addEventListener(\"beforeunload\", () => this.fireBeacon(\"end\", this.currentTime.toFixed(0)))\n  }\n\n  generateNielsenVO(type) {\n    let vo = {}\n    const events = this.config.events\n\n    switch (type) {\n      case \"content\":\n        if (events.video != null)\n          vo = events.video\n      break\n\n      case \"static\":\n        vo = events.static\n      break\n\n      default:\n        vo = events.ad\n        vo.type = type\n    }\n\n    return vo\n  }\n\n  fireBeacon(eventName, object) {\n    const codes = {\n      \"loadmetadata\": 15,\n      \"play\": 5,\n      \"stop\": 7,\n      \"timeupdate\": 49,\n      \"end\": 57,\n      \"sendID3\": 55\n    }\n\n    this.player.logger.log(`[AMP Nielsen DCR Event] : Event - ${eventName}`, object)\n    this.sdk.ggPM(codes[eventName], object)\n  }\n\n  onready() {\n    const target = this.player.ads\n    if (target != null) {\n      target.addEventListener(\"onadstarted\", this.onadstarted)\n      target.addEventListener(\"onadended\", this.onadended)\n      target.addEventListener(\"onadtimeupdate\", this.onadtimeupdate)\n    }\n  }\n\n  onadstarted(event) {\n    this.adVO = event.detail\n    const type = this.adVO.type\n\n    if (type == \"midroll\" && this.adVO.position == 1)\n      this.fireBeacon(\"stop\", this.currentTime)\n\n    if (type == \"preroll\")\n      this.fireBeacon(\"loadmetadata\", this.generateNielsenVO(\"content\"))\n\n    if (this.adVO != null) {\n      this.fireBeacon(\"loadmetadata\", this.generateNielsenVO(type))\n    }\n  }\n\n  onadended() {\n    this.fireBeacon(\"stop\", this.currentTime)\n    if (this.adVO.type == \"midroll\" && this.adVO.totalAds == adVO.position)\n      this.fireBeacon(\"loadmetadata\", this.generateNielsenVO(\"content\"))\n  }\n\n  onadtimeupdate(event) {\n    const currentTime = Math.floor(event.detail)\n\n    if (this.currentTime != currentTime) {\n      this.currentTime = currentTime\n      this.fireBeacon(\"timeupdate\", this.currentTime)\n    }\n  }\n\n  onstarted() {\n    if (this.adVO && this.adVO.type == \"midroll\") {\n      this.fireBeacon(\"stop\", this.generateNielsenVO(this.adVO.type))\n    }\n    else {\n      this.fireBeacon(\"loadmetadata\", this.generateNielsenVO(\"content\"))\n    }\n  }\n\n  onended() {\n    this.fireBeacon(\"end\", this.currentTime)\n  }\n\n  ontimeupdate(event) {\n    let currentTime = (this.player.media.isLive) ? event.detail : Date.now() / 1000\n    currentTime = Math.floor(currentTime)\n\n    if (this.currentTime != currentTime) {\n      this.currentTime = currentTime\n      this.fireBeacon(\"timeupdate\", this.currentTime)\n    }\n  }\n\n  onmediasequenceaborted() {\n    this.fireBeacon(\"end\", this.currentTime)\n  }\n\n  ontimedmetadata(event) {\n    if (!this.isDTVR)\n      return\n    this.fireBeacon(\"sendID3\", event.data.body.info)\n  }\n}\n","import Nielsen from \"./Nielsen.js\"\n\nakamai.amp.AMP.registerPlugin(\"nielsen\", Nielsen.factory)\n\nexport {Nielsen}\n"]}