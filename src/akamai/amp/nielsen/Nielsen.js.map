{"version":3,"file":"Nielsen.js","sources":["../../../../src/Nielsen.js","../../../../src/main.js"],"sourcesContent":["export default class Nielsen extends akamai.amp.Plugin {\n\n  constructor(player, config) {\n    super(player, config)\n\n    this.bindHandlers([\"onadstarted\", \"onadended\", \"onadtimeupdate\"])\n    this.sdk = window.NOLCMB.getInstance()\n    this.isDTVR = (this.config.data.dtvr === true)\n    window.addEventListener(\"beforeunload\", () => this.fireBeacon(\"end\", this.currentTime.toFixed(0)))\n  }\n\n  generateNielsenVO(type) {\n    let vo = {}\n    const events = this.config.events\n\n    switch (type) {\n      case \"content\":\n        if (events.video != null)\n          vo = events.video\n      break\n\n      case \"static\":\n        vo = events.static\n      break\n\n      default:\n        vo = events.ad\n        vo.type = type\n    }\n\n    return vo\n  }\n\n  fireBeacon(eventName, object) {\n    const codes = {\n      \"loadmetadata\": 15,\n      \"play\": 5,\n      \"stop\": 7,\n      \"timeupdate\": 49,\n      \"end\": 57,\n      \"sendID3\": 55\n    }\n\n    this.player.logger.log(`[AMP Nielsen DCR Event] : Event - ${eventName}`, object)\n    this.sdk.ggPM(codes[eventName], object)\n  }\n\n  onready() {\n    const target = this.player.ads\n    if (target != null) {\n      target.addEventListener(\"onadstarted\", this.onadstarted)\n      target.addEventListener(\"onadended\", this.onadended)\n      target.addEventListener(\"onadtimeupdate\", this.onadtimeupdate)\n    }\n  }\n\n  onadstarted(event) {\n    this.adVO = event.detail\n    const type = this.adVO.type\n\n    if (type == \"midroll\" && this.adVO.position == 1)\n      this.fireBeacon(\"stop\", this.currentTime)\n\n    if (type == \"preroll\")\n      this.fireBeacon(\"loadmetadata\", this.generateNielsenVO(\"content\"))\n\n    if (this.adVO != null) {\n      this.fireBeacon(\"loadmetadata\", this.generateNielsenVO(type))\n    }\n  }\n\n  onadended() {\n    this.fireBeacon(\"stop\", this.currentTime)\n    if (this.adVO.type == \"midroll\" && this.adVO.totalAds == adVO.position)\n      this.fireBeacon(\"loadmetadata\", this.generateNielsenVO(\"content\"))\n  }\n\n  onadtimeupdate(event) {\n    const currentTime = Math.floor(event.detail)\n\n    if (this.currentTime != currentTime) {\n      this.currentTime = currentTime\n      this.fireBeacon(\"timeupdate\", this.currentTime)\n    }\n  }\n\n  onstarted() {\n    if (this.adVO && this.adVO.type == \"midroll\") {\n      this.fireBeacon(\"stop\", this.generateNielsenVO(this.adVO.type))\n    }\n    else {\n      this.fireBeacon(\"loadmetadata\", this.generateNielsenVO(\"content\"))\n    }\n  }\n\n  onended() {\n    this.fireBeacon(\"end\", this.currentTime)\n  }\n\n  ontimeupdate(event) {\n    let currentTime = (this.player.media.isLive) ? event.detail : Date.now() / 1000\n    currentTime = Math.floor(currentTime)\n\n    if (this.currentTime != currentTime) {\n      this.currentTime = currentTime\n      this.fireBeacon(\"timeupdate\", this.currentTime)\n    }\n  }\n\n  onmediasequenceaborted() {\n    this.fireBeacon(\"end\", this.currentTime)\n  }\n\n  ontimedmetadata(event) {\n    if (!this.isDTVR)\n      return\n    this.fireBeacon(\"sendID3\", event.data.body.info)\n  }\n}\n","import Nielsen from \"./Nielsen.js\"\n\nakamai.amp.AMP.registerPlugin(\"nielsen\", Nielsen.factory)\n\nexport {Nielsen}\n"],"names":["Nielsen","player","config","bindHandlers","sdk","window","NOLCMB","getInstance","isDTVR","data","dtvr","addEventListener","fireBeacon","currentTime","toFixed","type","vo","events","video","static","ad","eventName","object","codes","logger","log","ggPM","target","ads","onadstarted","onadended","onadtimeupdate","event","adVO","detail","position","generateNielsenVO","totalAds","Math","floor","media","isLive","Date","now","body","info","akamai","amp","Plugin","AMP","registerPlugin","factory"],"mappings":"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"}